<!DOCTYPE html>
<html>
    <head>
        <title>用户禁言</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
<body>
	<div>
		<div  id="user-tabs"  style="margin-top:20px;">
			<span id="1">禁言</span>
			<span id="2" class="user-gray" onclick="window.location.href='{:U(\"Forbid/forbidLogin\")}'">冻结</span>
			<span id="3" class="user-gray" onclick="window.location.href='{:U(\"Forbid/kickPlayer\")}'">下线</span>
			<hr/>
		</div>
		<div id="tabs-1" class="tabitem">
			<div>
				<table class="explain">
					<tbody style="font-family:Mingliu">
						<tr>
							<td width="5%"  class="tableleft"><b>说明：</b></td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">1、输入角色名对玩家实行<font color = "red"><b>禁言</b></font>/<font color = "red"><b>解禁</b></font>；</td>
						</tr>
					</tbody>
				</table>
			</div>	
			<div>
				<table width="100%" border="0" cellspacing="0" cellpadding="0" align="left" class="toptable">
					<tbody>
						<tr>
							<td width="5%" class="tableright">
								<span>服务器：</span>
							</td>
							<td width="95%" class="tableleft">
								<select id="serverId">
			                        <volist name="serverList" id="sl">
			                            <option value="{$sl['g_id']}">{$sl['g_name']}</option>
			                        </volist>
			                        <option value="0">全部</option>
			                    </select>
							</td>
						</tr>
						<tr>
							<td width="5%" class="tableright">角色名：</td>
							<td width="95%" class="tableleft">
								<input type="input" class="input1" id="rolename1" size='115'/>
								<label><font color="red"><i><b>注</b>：批量账号则用英文分号隔开区分，例子:a;b;c</i></font></label>
							</td>
						</tr>
						<tr>
							<td width="5%" class="tableright">
								<span>禁言时长：</span>
							</td>
							<td width="95%" class="tableleft">
								<select id="stoptime">
									<option value="315360000">永久</option>
									<option value="60">1分钟</option>
									<option value="300">5分钟</option>
									<option value="600">10分钟</option>
									<option value="1800">30分钟</option>
									<option value="3600">1小时</option>
								</select>
							</td>
						</tr>
						<tr>
							<td width="5%" class="tableright">
								<span>操作原因：</span>
							</td>
							<td width="95%" class="tableleft">
								<textarea class="input1" cols="100" rows="2" id="reason">玩家因发布不文明信息，禁言</textarea>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="button" value="禁言" id="stopspeak"/>
								<input type="button" value="解禁" id="allowspeak"/>
								<input type="button" value="刷新页面查看处理结果" onclick="getForbidChatList(1);"/>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div style="clear: both"></div>
			<div>
				<table class="mytable">
					<thead>
						<tr>
							<th>服务器</th>
							<th>角色名</th>
							<th>状态</th>
							<th>解禁时间</th>
							<th>禁言时长</th>
							<th>封禁原因</th>
							<th>操作者</th>
							<th>后端状态</th>
							<th>失败原因</th>
						</tr>
					</thead>
					<tbody id="stoptable">
					</tbody>
				</table>
				<div id="pagehtml" style="float:right;margin-right:20px"></div>
				<div id="example_length" class="dataTables_length" style="display:none">
					<label>每页显示
						<select id="menu" name="example_length" size="1" aria-controls="example">
						<option value="10" selected="selected">10</option>
						<option value="25">25</option>
						<option value="50">50</option>
						<option value="100">100</option>
						</select> 条记录
					</label>
				</div>
				<input type="hidden" value="" id="ids"/>
			</div>
		</div>
		<div style="clear:both"></div>
		<div style="height:50px">&nbsp;</div>
	</div>
	
		<!-- 服务器 -->
        <div id="sform" style="display:none">
            <div class="ajaxform">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tr>
					<td>
					<volist name="serverList" id="sld" key="k">
                        <if condition="$k%5 eq 0">
                            <br/>
                            <br/>
                        </if>
                        <input type="radio" name="db" value="{$sld['g_id']}" class="cbox" id="s{$k}"/>
                        <label for="s{$k}">
                            {$sld['g_name']}
                        </label>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    </volist>
					</td>
				</tr>
                </table>
            </div>
        </div>
	
	<script src="__STATIC__/jquery.js" type="text/javascript"></script>
	<script src="__JS__/jquery-ui.js" type="text/javascript"></script> 
	<script src="__JS__/function.js" type="text/javascript"></script>
<script type="text/javascript">
	$(document).ready(function(){
	    showTitle("GM工具:游戏账号禁封");
	    
	    $("#serverId").change(function(){
	        if ($("#serverId").val() == 0) {
	            $("#sform").dialog({
	                height: 500,
	                width: 700,
	                buttons: {
	                    "确认": function(){
	                        var item = $(':radio[name="db"]:checked').val();
	                        $("#serverId").val(item);
	                        $(this).dialog("close");
	                        getForbidChatList(1);
	                    },
	                    "关闭": function(){
	                        $(this).dialog("close");
	                    }
	                }
	            })
	        }
	        else {
	            getForbidChatList(1);
	        }
	    });
		
		getForbidChatList(1);
		
        //禁言每页显示
        $("#menu").change(function(){
            getForbidChatList(1);
        });
	
        //禁言
        $("#stopspeak").click(function(){
            var serverId = $("#serverId").val();
            var rolename = $("#rolename1").val();
            var stoptime = $("#stoptime").val();
            var reason = $("#reason").val();
            
            if ("" == rolename) {
                alert("请输入角色名！");
                return false;
            }
            
            $.post('{:U("Forbid/forbidChatAction")}', {
                serverId: serverId,
                rolename: rolename,
                stoptime: stoptime,
                reason: reason
            }, function(data){
                alert(data.info);
				if(data.status){
					window.location.reload();
				}
            }, 'json');
        });
        
        //解禁
        $("#allowspeak").click(function(){
            var serverId = $("#serverId").val();
            var rolename = $("#rolename1").val();
            var stoptime = 0;
            var reason = $("#reason").val();
            
            if ("" == rolename) {
                alert("请输入角色名！");
                return false;
            }
            
            $.post('{:U("Forbid/forbidChatAction")}', {
                serverId: serverId,
                rolename: rolename,
                stoptime: stoptime,
                reason: reason
            }, function(data){
                alert(data.info);
				if(data.status){
					window.location.reload();
				}
            }, 'json')
        });
		
	});
	
	//禁言获取表格数据
	function getForbidChatList(page){
		$.ajax({
			type:"POST",
			url:"{:U('Forbid/getForbidChatList')}",
			data:
			{
				serverId : $("#serverId").val(),
				pageSize : $("#menu").val(),
				curPage : page
			},
			dataType:"json",
			beforeSend:function(){
				$("#example_length").hide();
				$("#stoptable").html("<tr><td colspan='10'><img src='__IMG__/loading.gif'/></td></tr>");
			},
			success:function(data){
				if(data.status==0){
					alert(data.info);return false;
				}
				var list = data.list;
				var serverList = data.serverList;
				if(list==null){
					$("#stoptable").html("<tr><td colspan='10'>没有数据</td></tr>");
				}else {
					var html = "";
					for(var i in list){
						var crole = "noclass";
						var ccall = "noclass";
						
						switch(parseInt(list[i]["s_roleStatus"])){
							case 2: crole="fail";list[i]["s_roleStatus"] = "失败";break;
							case 0: list[i]["s_roleStatus"] = "正在处理";break;
							case 1: list[i]["s_roleStatus"] = "成功";break;
							default: list[i]["s_roleStatus"] = "未知";crole="fail";break;
						}
					
						switch(parseInt(list[i]["s_status"])){
							case 1: list[i]["s_status"] = "禁言";break;
							case 2: list[i]["s_status"] = "解禁";break;
							default: list[i]["s_status"] = "未知";ccall="fail";
						}
						if(parseInt(list[i]["s_secends"]) == 315360000){
							list[i]["s_secends"] = "永久";
							list[i]["s_time"] = "永久";
						}else{
							list[i]["s_secends"] = list[i]["s_secends"] + "s";
						}
						
						html += "<tr id="+"stop"+list[i]["s_id"]+" >";
						html += "<td>"+serverList[list[i]["s_ip"]]['g_name']+"</td>";
						html += "<td>"+list[i]["s_role_name"]+"</td>";
						html += "<td>"+list[i]["s_status"]+"</td>";
						html += "<td>"+list[i]["s_time"]+"</td>";
						html += "<td>"+list[i]["s_secends"]+"</td>";
						html += "<td>"+list[i]["s_reason"]+"</td>";
						html += "<td>"+list[i]["s_operaor"]+"</td>";
						html += "<td class='"+crole+"'>"+list[i]["s_roleStatus"]+"</td>";
						html += "<td class='"+ccall+"'>"+list[i]["CmCmdResult"]+"</td>";
						html += "</tr>"
			
					}
					$("#stoptable").html(html);
					$("#stoptable tr:odd").css("background-color", "#edf2f7"); 
					$("#stoptable tr:even").css("background-color","#e0f0f0");
					$("#example_length").show();//显示每页
					$("#pagehtml").html(data.pageHtml);
				}
			},
			error:function(){
				$("#stoptable").html("<tr><td colspan='10'>没有数据</td></tr>");
			}
		});
	}

	//跳到相应页面 
	function go(){
		var pagenum = $("#page").val();
		if(pagenum=='' || isNaN(pagenum) || pagenum <= 0){
			alert('请输入一个正整数！');
			$("#page").val(1);
		}else{
			getForbidChatList(pagenum);
		}
	}
</script>
</body>
</html>