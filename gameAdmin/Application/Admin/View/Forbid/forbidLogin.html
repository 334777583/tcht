<!DOCTYPE html>
<html>
    <head>
        <title>用户禁言</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
<body>
	<div>
		<div  id="user-tabs"  style="margin-top:20px;">
			<span id="1" class="user-gray" onclick="window.location.href='{:U(\"Forbid/forbidChat\")}'">禁言</span>
			<span id="2">冻结</span>
			<span id="3" class="user-gray" onclick="window.location.href='{:U(\"Forbid/kickPlayer\")}'">下线</span>
			<hr/>
		</div>
		<div id="tabs-2" class="tabitem">	
			<div>
				<table class="explain">
					<thead>
					</thead>
					<tbody style="font-family:Mingliu">
						<tr>
							<td width="5%"  class="tableleft"><b>说明：</b></td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">1、输入角色名对玩家实行<font color = "red"><b>冻结</b></font>/<font color = "red"><b>解冻</b></font>；<font color = "red"><b>冻结</b></font>玩家在所冻结时间内无法再上线,请谨慎操作！</td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">2、冻结失败，请确认玩家没有被冻结，也可以先解冻然后再冻结，如还有问题请咨询程序</td>
						</tr>
					</tbody>
				</table>
			</div>	
			<div>
				<table width="100%" border="0" cellspacing="0" cellpadding="0" align="left" class="toptable">
					<tbody>
						<tr>
							<td width="5%" class="tableright">
								<span>服务器：</span>
							</td>
							<td width="95%" class="tableleft">
								<select id="serverId">
			                        <volist name="serverList" id="sl">
			                            <option value="{$sl['g_id']}">{$sl['g_name']}</option>
			                        </volist>
			                        <option value="0">全部</option>
			                    </select>
							</td>
						</tr>
						<tr>
							<td width="5%" class="tableright">角色名：</td>
							<td width="95%" class="tableleft">
								<input type="input" class="input1" id="rolename2" size='117'/>
								<label><font color="red"><i><b>注</b>：批量账号则用英文分号隔开区分，例子:a;b;c</i></font></label>
							</td>
						</tr>
						<tr>
							<td width="5%" class="tableright">
								<span>冻结时长：</span>
							</td>
							<td width="95%" class="tableleft">
								<select id="freezetime">
									<option value="315360000">永久</option>
									<option value="60">1分钟</option>
									<option value="300">5分钟</option>
									<option value="600">10分钟</option>
									<option value="1800">30分钟</option>
									<option value="3600">1小时</option>
								</select>
							</td>
						</tr>
						<tr>
							<td width="5%" class="tableright">
								<span>操作原因：</span>
							</td>
							<td width="95%" class="tableleft">
								<textarea class="input1" cols="100" rows="2" id="freezereason">玩家开挂，冻结</textarea>
							</td>
						</tr>
						<tr>
							<td colspan="2">
								<input type="button" value="冻结" id="freezeRole"/>
								<input type="button" value="解冻" id="unfreezeRole"/>
								<input type="button" value="刷新页面查看处理结果" onclick="getForbidLoginList(1);"/>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div style="clear: both"></div>
			<div>
				<table  class="mytable">
					<thead>
						<tr>
							<th>服务器</th>
							<th>角色名</th>
							<th>状态</th>
							<th>解冻时间</th>
							<th>冻结时长</th>
							<th>冻结原因</th>
							<th>操作者</th>
							<th>角色状态</th>
							<th>请求状态</th>
						</tr>
					</thead>
					<tbody id="freezetable">
					</tbody>
				</table>
				<div id="pagehtml2" style="float:right;margin-right:20px"></div>
				<div id="example_length2" class="dataTables_length" style="display:none">
					<label>每页显示
						<select id="menu2" name="example_length" size="1" aria-controls="example">
							<option value="10" selected="selected">10</option>
							<option value="25">25</option>
							<option value="50">50</option>
							<option value="100">100</option>
						</select> 条记录
					</label>
				</div>
				<input type="hidden" value="" id="ids2"/>
			</div>
		</div>
		<div style="clear:both"></div>
		<div style="height:50px">&nbsp;</div>
	</div>
	
		<!-- 服务器 -->
        <div id="sform" style="display:none">
            <div class="ajaxform">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tr>
					<td>
					<volist name="serverList" id="sld" key="k">
                        <if condition="$k%5 eq 0">
                            <br/>
                            <br/>
                        </if>
                        <input type="radio" name="db" value="{$sld['g_id']}" class="cbox" id="s{$k}"/>
                        <label for="s{$k}">
                            {$sld['g_name']}
                        </label>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    </volist>
					</td>
				</tr>
                </table>
            </div>
        </div>
	
	<script src="__STATIC__/jquery.js" type="text/javascript"></script>
	<script src="__JS__/jquery-ui.js" type="text/javascript"></script> 
	<script src="__JS__/function.js" type="text/javascript"></script>
<script type="text/javascript">
	$(document).ready(function(){
        showTitle("GM工具:游戏账号禁封");
        
        $("#serverId").change(function(){
            if ($("#serverId").val() == 0) {
                $("#sform").dialog({
                    height: 500,
                    width: 700,
                    buttons: {
                        "确认": function(){
                            var item = $(':radio[name="db"]:checked').val();
                            $("#serverId").val(item);
							getForbidLoginList(1);
                            $(this).dialog("close");
                        },
                        "关闭": function(){
                            $(this).dialog("close");
                        }
                    }
                })
            }
            else {
                getForbidLoginList(1);
            }
        });
		
        $("#menu2").change(function(){
            getForbidLoginList(1);
        });
		
        //冻结
        $("#freezeRole").click(function(){
            var serverId = $("#serverId").val();
            var rolename = $("#rolename2").val();
            var freezetime = $("#freezetime").val();
            var reason = $("#freezereason").val();
            
            if ("" == rolename) {
                alert("请输入角色名！");
                return false;
            }
            
            $.post('{:U("Forbid/FobidLoginAction")}', {
                serverId: serverId,
                rolename: rolename,
                freezetime: freezetime,
                reason: reason,
				action:1
            }, function(data){
                alert(data.info);
				if(data.status){
					window.location.reload();
				}
            }, 'json')
        });
        
        //解冻
        $("#unfreezeRole").click(function(){
            var serverId = $("#serverId").val();
            var rolename = $("#rolename2").val();
            var freezetime = 0;
            var reason = $("#freezereason").val();
            
            if ("" == rolename) {
                alert("请输入角色名！");
                return false;
            }
            
            $.post('{:U("Forbid/FobidLoginAction")}', {
                serverId: serverId,
                rolename: rolename,
                freezetime: freezetime,
                reason: reason,
				action:2
            }, function(data){
                alert(data.info);
				if(data.status){
					window.location.reload();
				}
            }, 'json')
        });
		
		getForbidLoginList(1);
		
	});
	
	//冻结获取表格数据
	function getForbidLoginList(page){
		$.ajax({
			type:"POST",
			url:"{:U('Forbid/getForbidLoginList')}",
			data:
			{
				serverId : $("#serverId").val(),
				pageSize : $("#menu2").val(),
				curPage : page
			},
			dataType:"json",
			beforeSend:function(){
				$("#freezetable").html("<tr><td colspan='10'><img src='__IMG__/loading.gif'/></td></tr>");
			},
			success:function(data){
				var list = data.list;
				if(list != null ){
					var html = "";
					for(var i in list){
						var crole = "noclass";
						var ccall = "noclass";
						
						switch(parseInt(list[i]["f_callstatus"])){
							case 0: list[i]["f_callstatus"] = "失败";ccall="fail";break;
							case 1: list[i]["f_callstatus"] = "正在处理";break;
							case 2: list[i]["f_callstatus"] = "成功";break;
							default: list[i]["f_callstatus"] = "未知";ccall="fail";
						}
						switch(parseInt(list[i]["f_roleStatus"])){
							case 1: list[i]["f_roleStatus"] = "成功";break;
							case 2: list[i]["f_roleStatus"] = "处理失败";ccall="fail";break;		
							default: list[i]["f_roleStatus"] = "正在处理";
						}
						
						switch(parseInt(list[i]["f_status"])){
							case 1: list[i]["f_status"] = "冻结";break;
							case 2: list[i]["f_status"] = "解冻";break;
							default: list[i]["f_status"] = "未知";crole="fail";
						}
						if(parseInt(list[i]["f_secends"]) == -1){
							list[i]["f_secends"] = "永久";
							list[i]["f_time"] = "永久"
						}else{
							list[i]["f_secends"] = list[i]["f_secends"] + "s";
						}
						
						html += "<tr id="+"freeze"+list[i]["f_id"]+" >";
						html += "<td>"+data.serverList[list[i]["f_ip"]]['g_name']+"</td>";
						html += "<td>"+list[i]["f_role_name"]+"</td>";
						html += "<td>"+list[i]["f_status"]+"</td>";
						html += "<td>"+list[i]["f_time"]+"</td>";
						html += "<td>"+list[i]["f_secends"]+"</td>";
						html += "<td>"+list[i]["f_reason"]+"</td>";
						html += "<td>"+list[i]["f_operaor"]+"</td>";
						html += "<td class='"+crole+"'>"+list[i]["f_roleStatus"]+"</td>";
						html += "<td class='"+ccall+"'>"+list[i]["f_callstatus"]+"</td>";
						html += "</tr>";
					}
					$("#freezetable").html(html);
					$("#freezetable tr:odd").css("background-color", "#edf2f7"); 
					$("#freezetable tr:even").css("background-color","#e0f0f0");
					$("#example_length2").show();//显示每页
					$("#pagehtml2").html(data.pageHtml);
				}else{
					$("#freezetable").html("<tr><td colspan='10'>没有数据！</td></tr>");
				}
			},
			error:function(){
				$("#freezetable").html("<tr><td colspan='10'>没有数据！</td></tr>");
			}
		})
	}
	
	//跳到相应页面 
	function go(){
		var pagenum = $("#page").val();
		if(pagenum=='' || isNaN(pagenum) || pagenum <= 0){
			alert('请输入一个正整数！');
			$("#page").val(1);
		}else{
			getForbidLoginList(pagenum);
		}
	}
</script>
</body>
</html>