<!DOCTYPE html>
<html>
    <head>
        <title>道具审批</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
<body>
	<div>
		<div id="tabs-1" class="tabitem">
			<div>
				<table class="explain">
					<thead>
					</thead>
					<tbody style="font-family:Mingliu">
						<tr>
							<td width="5%"  class="tableleft"><b>说明：</b></td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">1、谨慎处理运营申请道具奖励，<font color = "red"><b>通过</b></font>前请仔细查看道具详情,点击<font color = "red"><b>明细</b></font>查看！</td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">2、批量操作只处理未审核的，已处理过的会跳过该条记录不处理</td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">3、默认显示所有没有审核的申请</td>
						</tr>
					</tbody>
				</table>
			</div>
			<div class="topinfo">
				<div>
					<span>服务器</span>
                    <select id="serverId">
                        <volist name="serverList" id="sl">
                            <option value="{$sl['g_id']}">{$sl['g_name']}</option>
                        </volist>
                        <option value="0">全部</option>
                    </select>
					<span>审核状态</span>
					<select id="s_type">
						<option value="1">未审核</option>
						<option value="2">不通过</option>
						<option value="4">发送成功</option>
						<option value="3">发送失败</option>
						<option value="10">全部</option>
					</select>
					<span>开始日期：</span>
					<input type="text" id="startdate" class="input1"/>
					<span>结束日期：</span>
					<input type="text" id="enddate" class="input1"/>
					<input type="button" value="搜索" style="margin-left:20px" id="serach"/>
					<!--
					<input type="button" value="批量通过" style="margin-left:20px" id="pass_all"/>
					<input type="button" value="批量不通过" style="margin-left:20px" id="fail_all"/>
					<input type="button" value="刷新页面查看处理结果" onclick="showTable(1);"/>
					-->
				</div>
			</div>
			<div style="clear:both"></div>
			<div>
				<table  class="mytable">
					<thead>
						<tr>
							<th><input type='checkbox' id='c_all'/></th>
							<th>服务器</th>
							<th>申请者</th>
							<th>申请时间</th>
							<th>元宝</th>
							<th>铜钱</th>
							<th>申请原因</th>
							<th>信件内容</th>
							<th>赠送玩家列表</th>
							<th>道具详情</th>
							<th>审核状态</th>
							<th>审核人</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="passBody">
					</tbody>
				</table>
				<div id="pagehtml" style="float:right;margin-right:20px"></div>
				<div id="example_length" class="dataTables_length" style="display:none">
					<label>每页显示
						<select id="menu" name="example_length" size="1" aria-controls="example">
						<option value="10" selected="selected">10</option>
						<option value="15">15</option>
						<option value="25">25</option>
						<option value="50">50</option>
						<option value="100">100</option>
						</select> 条记录
					</label>
				</div>
			</div>

		</div>
		<div style="height:50px">&nbsp;</div>
	</div>
	
	<!--弹出覆盖层-->
	<div class="overlay" style="display:none">
		<table style="width:220px;height:100%;margin:0 auto;">
			<tr>
				<td style="text-align:center">
					<img src='__IMG__/ajax-loader.gif'/>
				</td>
			</tr>
		</table>
	</div>
	
	
		<!-- 金钱与道具详情 -->
	<div id="form"  style="display:none">
		<div class="ajaxform">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tbody>
					<tr id="lv_info" style="display:none">
						<td>
							<table cellspacing="0" cellpadding="0" style="border: 1px solid #859497;" width="100%">
								<tr>
									<td>
										<span>最小等级：</span><span id="t_minlv">0</span>
									</td>
								</tr>
								<tr>
									<td>
										<span>最大等级：</span><span id="t_maxlv">0</span>
									</td>
								</tr>
								<tr>
									<td>
										<span>邮件接收截止时间：</span><span id="t_endtime">0</span>
									</td>
								</tr>
							</table>
						</td>
					</tr>
					<tr>
						<td>金钱：</td>
					</tr>
					<tr>
						<td>
							<table class="tooltable">
								<thead>
									<tr>
										<th>
											<span>元宝：</span><span id="f_gold">0</span>
										</th>
										<th>
											<span>铜币：</span>
											<span id="f_copper">0</span>
										</th>
									</tr>
								</thead>
							</table>
						</td>
					</tr>
					<tr>
						<td>道具列表：</td>
					</tr>
					<tr>
						<td>
							<table class="tooltable">
								<thead>
									<tr>
										<th>道具ID</th>
										<th>道具名称</th>
										<th>数量</th>
										<th>绑定状态（0为非绑定，1为绑定）</th>
									</tr>
								</thead>
								<tbody id="form_tools">
								</tbody>
							</table>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	
		<!-- 服务器 -->
        <div id="sform" style="display:none">
            <div class="ajaxform">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tr>
					<td>
					<volist name="serverList" id="sld" key="k">
                        <if condition="$k%5 eq 0">
                            <br/>
                            <br/>
                        </if>
                        <input type="radio" name="db" value="{$sld['g_id']}" class="cbox" id="s{$k}"/>
                        <label for="s{$k}">
                            {$sld['g_name']}
                        </label>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    </volist>
					</td>
				</tr>
                </table>
            </div>
        </div>
	
	<script src="__STATIC__/jquery.js" type="text/javascript"></script>
	<script src="__JS__/jquery-ui.js" type="text/javascript"></script> 
	<script src="__JS__/function.js" type="text/javascript"></script>
	<script type="text/javascript">
		$(document).ready(function(){
			//时间插件
		$("#startdate").datepicker();
		$("#enddate").datepicker();
		showTitle("GM工具:道具审批");
		
        $("#serverId").change(function(){
            if ($("#serverId").val() == 0) {
                $("#sform").dialog({
                    height: 500,
                    width: 700,
                    buttons: {
                        "确认": function(){
                            var item = $(':radio[name="db"]:checked').val();
                            $("#serverId").val(item);
                            $(this).dialog("close");
							getApplyList(1);
                        },
                        "关闭": function(){
                            $(this).dialog("close");
                        }
                    }
                })
            }else {
				getApplyList(1);
			}
        });
				
		//验证数据
		var validator = function(){
			var isok = true;
			var reg = /\d{4}-\d{2}-\d{2}/;
			var start = $("#startdate").val();
			var end = $("#enddate").val();
			if (start != "" && end != ""){
				if(!reg.test(start) || !reg.test(end)){
					alert("请输入格式为YYYY-MM-DD的时间");
					isok = false;
				}else if(start>end){
					alert("结束时间要大于开始时间！");
					isok = false;
				}
			}
			return isok;
		}
		
		//搜索
		$("#serach").click(function(){
			if(validator()){
				getApplyList(1);
			}
		});
		
		//页面加载显示table
		getApplyList(1);
		
		//改变显示页码
		$("#menu").change(function(){
			getApplyList(1);
		});
		
		//全选
		$("#c_all").click(function(){
			if($(this).is(":checked")) {
				$("input[name=user]").attr("checked", true);
			} else {
				$("input[name=user]").removeAttr("checked");
			}
		});
		
		//通过申请记录id，获取申请道具详细
        $(".tdetial").live("click", function(){
            var tid = $(this).parents('tr').attr("tid");
            var str = $(this).prev().prev().text();
            if (str == "全服") {
                $("#lv_info").show();
            }else {
                $("#lv_info").hide();
            }
            
            $.ajax({
                type: "post",
                url: "{:U('ToolsApply/getApplyDetail')}",
                dataType: "json",
                data: {
                    tid: tid
                },
                cache: false,
                beforeSend: function(){
                    $(".overlay").show();
                },
                complete: function(){
                    $(".overlay").hide();
                },
                success: function(data){
					if(data.status==0){
						alert(data.info);return false;
					}
					
                    if (data.moneyList !=null) {
                        $("#f_gold").html(data.moneyList["t_gold"]);
                        $("#f_copper").html(data.moneyList["t_copper"]);
                        if (data.moneyList["t_minlv"] == '0') {
                            data.moneyList["t_minlv"] = "无限制"
                        }
                        if (data.moneyList["t_maxlv"] == '0') {
                            data.moneyList["t_maxlv"] = "无限制"
                        }
                        if (data.moneyList["t_endtime"] == '0') {
                            data.moneyList["t_endtime"] = "系统默认"
                        }
                        
                        $("#t_minlv").html(data.moneyList["t_minlv"]);
                        $("#t_maxlv").html(data.moneyList["t_maxlv"]);
                        $("#t_endtime").html(data.moneyList["t_endtime"]);
                    }
                    
                    if (data.toolList ==null) {
						$("#form_tools").html("<tr><td colspan='7'>没有记录！</td></tr>");
                    }else {
                        var html = "";
                        for (var i in data.toolList) {
                            html += "<tr>";
                            html += "<td>" + data.toolList[i]["t_tid"] + "</td>";
                            html += "<td>" + data.toolList[i]["t_name"] + "</td>";
                            html += "<td>" + data.toolList[i]["t_num"] + "</td>";
                            html += "<td>" + data.toolList[i]["t_bstatus"] + "</td>";
                            html += "</tr>";
                        }
                        $("#form_tools").html(html);
                    }
                    
                    $("#form").dialog({
                        height: 500,
                        width: 700,
                        buttons: {
                            "关闭": function(){
                                $(this).dialog("close");
                            }
                        }
                    })
                },
                error: function(){
                    alert("获取申请详细，请求失败");
                }
            })
        });
		
		//审核通过
		$(".tpass").live("click",function(){
			var tid = $(this).parents('tr').attr("tid");
			$.ajax({
				type : "post",
				url : "{:U('ToolsPass/toolsAskPass')}",
				dataType : "json",
				data : {
					tid : tid
				},
				beforeSend : function(){
					$(".overlay").show();
				},
				complete : function(){
					$(".overlay").hide();
				},
				success : function(data){
					alert(data.info);
					if(data.status){
						window.location.reload();
					}
				},
				error:function(){
					alert("请求失败");
				}
			})
			
		});
		
		
		//审核不通过
		$(".notpass").live("click",function(){
			var tid = $(this).parents('tr').attr("tid");
			$.ajax({
				type : "POST",
				url : "{:U('ToolsPass/toolsAskNoPass')}",
				dataType : "json",
				data : {
					tid : tid
				},
				beforeSend : function(){
					$(".overlay").show();
				},
				complete : function(){
					$(".overlay").hide();
				},
				success : function(data){
					alert(data.info);
					if(data.status){
						window.location.reload();
					}
				},
				error:function(){
					alert("请求失败");
				}
			});
		});
			
		});
		
		//显示申请审核列表
		function getApplyList(page){
			$.ajax({
				type:"POST",
				dataType:"json",
				url:"{:U('ToolsPass/getApplyList')}",
				data:
				{
					pageSize : $("#menu").val(),
					curPage : page,
					startdate : $("#startdate").val(),
					enddate : $("#enddate").val(),
					serverId : $("#serverId").val(),
					stype : $("#s_type").val()
				},
				beforeSend:function(){
					$("#passBody").html("<tr><td colspan='15'><img src='__IMG__/loading.gif'/></td></tr>");
				},
				success:function(data){
					if(data.status==0){
						alert(data.info);
						$("#passBody").html("<tr><td colspan='15'>没有数据！</td></tr>");
						return false;
					}
					var list = data.list;
					var serverList = data.serverList;
					if(list != null ){
						var tbody = "";
						for(var i in list){
							var model = "noclass";
							var text = "";
							switch(parseInt(list[i]["t_status"])){
								case 1: 
									text = "未审核";
									break;
								case 2: 
									text = "不通过";
									model="fail";
									break;
								case 3:
									text = "已审核但发送失败";
									model="fail";
									break;
								case 4:	
									text = "已审核并发送成功";
									model="pass";
									break;
								case -1:
									text = "申请已取消";
									model="fail";
									break;
								case -2:	
									text = "正在处理";
									info = "<span class='pass'>正在处理</span>";
									break;		
								default: 
									text = "未知";
									model="fail";		
									
							}
							
							tbody += "<tr tid='"+list[i]["t_id"]+"'>";
							tbody += "<td><input type='checkbox' name='user' value='"+list[i]["t_id"]+";"+list[i]["t_role_name"]+"'/></td>";
							tbody += "<td>"+serverList[list[i]["t_ip"]]['g_name']+"</td>";
							tbody += "<td>"+list[i]["t_operaor"]+"</td>";
							tbody += "<td>"+list[i]["t_inserttime"]+"</td>";
							tbody += "<td>"+list[i]["t_gold"]+"</td>";
							tbody += "<td>"+list[i]["t_copper"]+"</td>";
							tbody += "<td>"+list[i]["t_reason"]+"</td>";
							tbody += "<td>"+list[i]["t_content"]+"</td>";
							tbody += "<td>"+list[i]["t_role_name"]+"</td>";
							tbody += "<td class='tdetial'>明细</td>";
							tbody += "<td class='"+model+"' id='status_"+list[i]["t_id"]+"'>"+text+"</td>";
							tbody += "<td>"+list[i]["t_auditor"]+"</td>";
							if(parseInt(list[i]["t_status"]) == 3){
								tbody += "<td><span class='tpass'>重发</span><span class='notpass'>不通过</span></td>";
							}else if(parseInt(list[i]["t_status"]) == 2){
								tbody += "<td><span class='fail'>不通过</span></td>";
							}else if(parseInt(list[i]["t_status"]) == -1) { 
								tbody += "<td><span class='fail'>已取消</span></td>";
							}else if(parseInt(list[i]["t_status"]) == 4){
								tbody += "<td><span class='pass'>已发送</span></td>";
							}else if(parseInt(list[i]["t_status"]) == 1){
								tbody += "<td><span class='tpass'>通过</span><span class='notpass'>不通过</span></td>";
							}else if(parseInt(list[i]["t_status"]) == -2){
								tbody += "<td><span class='pass'>正在处理</span></td>";
							}else {
								tbody += "<td></td>";
							}
							tbody += "</tr>";
						}
						$("#passBody").html(tbody);
						$("#passBody tr:odd").css("background-color", "#edf2f7"); 
						$("#passBody tr:even").css("background-color","#e0f0f0");
						$("#example_length").show();//显示每页
						$("#pagehtml").html(data.pageHtml);
					}else{
						$("#example_length").hide();
						$("#passBody").html("<tr><td colspan='15'>没有数据！</td></tr>");
					}
				},
				error:function(){
					alert('请求失败');
				}
			})	
		}
		
		//跳到相应页面 
		function go(){
			var pagenum = $("#page").val();
			if(pagenum=='' || isNaN(pagenum) || pagenum <= 0){
				alert('请输入一个正整数！');
				$("#page").val(1);
			}else{
				getApplyList(pagenum);
			}
		}
		
	</script>
</body>
</html>