<!DOCTYPE html>
<html>
    <head>
        <title>商城消费统计</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
    <body>
	<div class="container">
			<div  id="user-tabs">
				<span>数据展示</span>
				<span class="user-gray" onclick="window.location.href='{:U(\"GameShop/chartShow\")}'">图表展示</span>
			</div>
			<hr/>
			
			<div>
				<table class="explain">
					<thead>
					</thead>
					<tbody style="font-family:Mingliu">
						<tr>
							<td width="5%"  class="tableleft"><b>说明：</b></td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">1、查询区间内游戏商城中<b>礼券</b>、<b>元宝</b>和<b>绑定元宝</b>消费的物品分析</td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">2、默认查询开服至今的数据，如不清楚开服日期请不要选择初始时间</td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">3、购买人数以角色计算</td>
						</tr>
					</tbody>
				</table>
			</div>
			
			<div class="topinfo">
				<div>
					<span>服务器:</span>
					<select id="serverId">
						<volist name="serverList" id="sl">
						<option value="{$sl['g_id']}">{$sl['g_name']}</option>
						</volist>
						<option value="0">全部</option>
					</select>
					<select id="money_type">
						<option value="3">元宝</option>
						<option value="4">绑定元宝</option>
						<option value="5">礼券</option>
					</select>
					<span>时间:</span>
					<input type="text" class="input1" id="startdate" />
					至<input type="text" class="input1" id="enddate" value="{$today}" />
					<input type="button" value="查询" id="querybtn" style="margin-left:20px"/>
				</div>
			</div>
			
			<div style="clear:both"></div>
			
			<div>
				<div>
					<table class="mytable">
						<thead id= 'am_thead'>
							<tr>
								<th>购买总人数</th>
								<th class="totalpeople">&nbsp;</th>
								<th>购买总数量</th>
								<th class="totalnum">&nbsp;</th>
								<th>购买总金额</th>
								<th class="totalprice">&nbsp;</th>
								<th>&nbsp;</th>
								<th>&nbsp;</th>
							</tr>
							<tr>
								<th>物品ID</th>
								<th>物品名称</th>
								<th>购买人数</th>
								<th>单价</th>
								<th>数量</th>
								<th>数量比</th>
								<th>总价</th>
								<th>总价比</th>
							</tr>
						</thead>
						<tbody id='am_body'>
						</tbody>
					</table>
				</div>
				
				<div style="display:none;" id="pagediv1" >
					<div style="float:right;margin-right:20px" id="pagehtml">
					<div class="pages">共&nbsp;707&nbsp;条记录
					<a onclick="getHistoryData(1)" href="javascript:void(0)">首页</a>&nbsp;&nbsp;
					<a onclick="getHistoryData(1)" href="javascript:void(0)">上一页</a>&nbsp;&nbsp;
					<a onclick="getHistoryData(2)" href="javascript:void(0)">下一页</a>&nbsp;&nbsp;
					<a onclick="getHistoryData(29)" href="javascript:void(0)">尾页</a>&nbsp;&nbsp;
					第1/29页&nbsp;&nbsp;转到<input type="text" class="text" size="3" value="1" id="page">
					<a onclick="go()" class="go" href="javascript:void(0);"></a>页</div>
					</div>
				</div>
				
			</div>
			
			<div style="margin-top:100px">
				<div>
					<table  class="mytable">
						<thead>
							<tr>
								<th width='15%'>日期</th>
								<th width='25%'>购买人数</th>
								<th width='25%'>购买数量</th>
								<th width='25%'>消费总额</th>
								<th width='10%'>消费占比</th>
							</tr>
						</thead>
						<tbody id='ad_body'>
						</tbody>
					</table>
				</div>
			</div>
			<div style="clear:both"></div>
	</div>
	
		<!-- 服务器 -->
        <div id="sform" style="display:none">
            <div class="ajaxform">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tr>
					<td>
					<volist name="serverList" id="sld" key="k">
                        <if condition="$k%5 eq 0">
                            <br/>
                            <br/>
                        </if>
                        <input type="radio" name="db" value="{$sld['g_id']}" class="cbox" id="s{$k}"/>
                        <label for="s{$k}">
                            {$sld['g_name']}
                        </label>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    </volist>
					</td>
				</tr>
                </table>
            </div>
        </div>
	
    <script src="__STATIC__/jquery.js" type="text/javascript">
    </script>
    <script src="__JS__/jquery-ui.js" type="text/javascript">
    </script>
    <script src="__JS__/function.js" type="text/javascript">
    </script>
	<script type="text/javascript">
	$(document).ready(function(){
		//时间插件
		$("#startdate").datepicker();
		$("#enddate").datepicker();

		showTitle("货币相关查询:商城消费统计");
		
        $("#serverId").change(function(){
            if ($("#serverId").val() == 0) {
                $("#sform").dialog({
                    height: 500,
                    width: 700,
                    buttons: {
                        "确认": function(){
                            var item = $(':radio[name="db"]:checked').val();
                            $("#serverId").val(item);
                            $(this).dialog("close");
                        },
                        "关闭": function(){
                            $(this).dialog("close");
                        }
                    }
                })
            }
        });
        
    	$('#querybtn').click(function(){
    		getData();
    	});
        
	});
	
	function getData(){
		$.ajax({
			type : 'POST',
			url : '{:U("GameShop/getData")}',
			dataType : 'json',
			data : {
				serverId : $("#serverId").val(),
				startdate : $('#startdate').val(),
				enddate : $('#enddate').val(),
				moneyType : $('#money_type').val()
			},
			beforeSend : function() {
				$("#am_body").html("<tr><td colspan='9'><img src='__IMG__/loading.gif'/></td></tr>");
				$("#ad_body").html("");
				$('.totalpeople').html("");
				$('.totalnum').html("");
				$('.totalprice').html("");
			},
			success : function (data) {
				var goodsdata = data.goodsdata;
				var datedata = data.datedata;
				if(goodsdata!=null&&goodsdata!='') {
					$('.totalpeople').html(data.total.people);
					$('.totalnum').html(data.total.num);
					$('.totalprice').html(data.total.price);
					
					var tbody1 = "";
					for(var i in goodsdata) {
						tbody1 += "<tr>";
						tbody1 += "<td>" + goodsdata[i]["goodsid"] + "</td>";
						tbody1 += "<td>" + goodsdata[i]["goodsname"] + "</td>";
						tbody1 += "<td>" + goodsdata[i]["people"] + "</td>";
						tbody1 += "<td>" + goodsdata[i]["price"] + "</td>";
						tbody1 += "<td>" + goodsdata[i]["num"] + "</td>";
						tbody1 += "<td>" + Math.round(goodsdata[i]["num"]*10000/data.total.num)/10000 + "</td>";
						tbody1 += "<td>" + goodsdata[i]["price"]*goodsdata[i]["num"] + "</td>";
						tbody1 += "<td>" + Math.round(goodsdata[i]["price"]*goodsdata[i]["num"]*10000/data.total.price)/10000 + "</td>";
						tbody1 += "</tr>";
					}
					$("#am_body").html(tbody1);
					$("#am_body tr:odd").css( "background-color", "#e0f0f0");
					
					var tbody = "";
					for(var i in datedata) {
						tbody += "<tr>";
						tbody += "<td>" + datedata[i]["date"] + "</td>";
						tbody += "<td>" + datedata[i]["people"] + "</td>";
						tbody += "<td>" + datedata[i]["num"] + "</td>";
						tbody += "<td>" + datedata[i]["price"] + "</td>";
						tbody += "<td>" + Math.round(datedata[i]["price"]*10000/data.total.price)/10000 + "</td>";
						tbody += "</tr>";
					}
					$('#startdate').val(datedata[0]["date"]);
					$("#ad_body").html(tbody);
					$("#ad_body tr:odd").css( "background-color", "#e0f0f0");
				}else {
					$("#dtatr_body").html("<tr><td colspan='9'>没有数据！</td></tr>");
				}
			},
			error : function () {
				$("#dtatr_body").html("<tr><td colspan='9'>请求失败！</td></tr>");
			}
		});
	}
	</script>
</body>
</html> 
