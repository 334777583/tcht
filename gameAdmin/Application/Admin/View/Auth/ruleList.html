<!DOCTYPE html>
<html>
    <head>
        <title>后台用户权限管理--模块列表</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
<body>
	<div class="container">
		<div>
			<div  id="user-tabs">
				<span id="1" class="user-gray" onclick="window.location.href='{:U(\"Auth/userList\")}'">基本信息</span>
				<span id="2" class="user-gray" onclick="window.location.href='{:U(\"Auth/roleAuthList\")}'">角色设置</span>
				<span id="3">模块设置</span>
			</div>
			<hr/>
			<div id="tabs-1" class="tabitem">
 					<div style="float:right">
 						<img src="__IMG__/add-btn2.png" style="cursor: pointer;" id="addbtn"/>
 					</div>
			 </div>
				<table class="mytable" id="mytable" cellspacing="0" align="center">
					<thead>
						<tr>
							<th>序号</th>
							<th>模块代码</th>
							<th>模块名称</th>
							<th>模块url</th>
							<th>模块pid</th>
							<th>创建时间</th>
							<th>修改时间</th>
							<th>操作</th>
						</tr>
					</thead>
					<tbody id="mbody">
						<volist name="code" id="c">
							<tr>
								<td>{$c['cf_id']}</td>
								<td>{$c['cf_code']}</td>
								<td>{$c['cf_name']}</td>
								<td>{$c['cf_url']}</td>
								<td>{$c['cf_pid']}</td>
								<td>{$c['cf_createtime']}</td>
								<td>{$c['cf_updatetime']}</td>
								<td cid="{$c['cf_id']}">
									<if condition="$c['cf_flag'] eq 0">
										<label class="stopicon"></label>
										<span class="stopbtn">停用</span>
									<elseif condition="$c['cf_flag'] eq 1"/>
										<label class="yesicon"></label>
										<span class="yesbtn">启用</span>
									</if>
									<label class="editicon"></label>
									<span class="editbtn">编辑</span>
									<label class="deleteicon"></label>
									<span class="deletebtn">删除</span>
								</td>
							</tr>
						</volist>
					</tbody>
				</table>
				<div id="pagehtml" style="float:right;margin-right:20px;display:block"></div>
				<div style="clear:both"></div>
				<div style="height:30px">&nbsp;</div>
			</div>
		</div>	
		
	<div id="confirm"  style="display:none">
		<div style="text-align: center;">确定要永久删除吗？</div>
	</div>
	
	<div id="editform"  style="display:none">
		<div class="ajaxform">
			<table width="80%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tbody>
					<tr>
						<td align="right">模块代码：</td>
						<td><input type="text" class="input-1" id="mcode" ></td>
					</tr>
					<tr>
						<td align="right">模块名称：</td>
						<td><input type="text" class="input-1" id="mname" ></td>
					</tr>
					<tr>
						<td align="right">模块PID：</td>
						<td>
							<select id="cfPid">
								<option value="0">顶级模块</option>
								<volist name="code" id="c1">
									<option value="{$c1['cf_id']}">{$c1['cf_name']}</option>
								</volist>
							</select>
						</td>
					</tr>
					<tr>
						<td align="right">模块URL：</td>
						<td><input type="text" class="input-1" id="cfUrl" ></td>
					</tr>
					<tr>
						<td align="right">模块状态：</td>
						<td>
							<select id="cfFlag">
								<option value="0">启用</option>
								<option value="1">停用</option>
							</select>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	
</body>

    <script src="__STATIC__/jquery.js" type="text/javascript">
    </script>
    <script src="__JS__/jquery-ui.js" type="text/javascript">
    </script>
    <script src="__JS__/function.js" type="text/javascript">
    </script>
	<script type="text/javascript">
	$(function() {
		showTitle("GM工具：权限管理");
		
		//停用
		$(".stopbtn").live("click",function(){
			var cid = $(this).parents('td').attr("cid");
			changeCodeFlag(cid,1,$(this));
		});
		
		//启用
		$(".yesbtn").live("click",function(){
			var cid = $(this).parents('td').attr("cid");
			changeCodeFlag(cid,0,$(this));
		});
		
		//编辑
		$(".editbtn").live("click",function(){
			var cid = $(this).parents('td').attr("cid");
			$.post(
					'{:U("Auth/getCode")}',
					{cid : cid},
					function(data){
						if(data.status){
							$("#mcode").val(data.code["cf_code"]);
							$("#mname").val(data.code["cf_name"]);
							$('#cfUrl').val(data.code['cf_url']);
							$('#cfPid').val(data.code['cf_pid']);
							$('#cfFlag').val(data.code['cf_flag']);
							$("#editform").dialog({
								height: 300,
								width: 400,
								buttons: {
									'保存' : function(){
										var mcode  = $("#mcode").val();
										var mname = $("#mname").val();
										var cfurl = $('#cfUrl').val();
										if(mcode==''){
											alert('请填写模块代码');return false;
										}else if(mname==''){
											alert('请填写模块名称');return false;
										}else if(cfurl==''){
											alert('请填写模块url');return false;
										}
										$.post(
											'{:U("Auth/updateCode")}',
											{
												cid : cid,
												mcode : mcode,
												mname : mname,
												cfUrl:cfurl,
												cfPid:$('#cfPid').val(),
												cfFlag:$('#cfFlag').val()
											},
											function(data){
												alert(data.info);
												if(data.status){
													window.location.reload();
												}
											},
											'json'
										)
									},
									'取消' : function(){
										$(this).dialog("close");
									}
								}
							})
						}else{
							alert(data.info);
						}
					},
					'json'
			)
		});
		
		//添加 
		$("#addbtn").click(function(){
			$("#mcode").val("");
			$("#mname").val("");
			$('#cfUrl').val("");
			$('#cfPid').val(0);
			$('#cfFlag').val(0);
			
			$("#editform").dialog({
				height: 300,
				width: 400,
				buttons: {
					'添加' : function(){
						var mcode  = $("#mcode").val();
						var mname = $("#mname").val();
						var cfurl = $('#cfUrl').val();
						if(mcode==''){
							alert('请填写模块代码');return false;
						}else if(mname==''){
							alert('请填写模块名称');return false;
						}else if(cfurl==''){
							alert('请填写模块url');return false;
						}
						$.post(
							'{:U("Auth/updateCode")}',
							{
								mcode : mcode,
								mname : mname,
								cfUrl:cfurl,
								cfPid:$('#cfPid').val(),
								cfFlag:$('#cfFlag').val()
							},
							function(data){
								alert(data.info);
								if(data.status){
									window.location.reload();
								}
							},
							'json'
						)
					},
					'取消' : function(){
						$(this).dialog("close");
					}
				}
			})
		
		});
		
		//删除
		$(".deletebtn").live("click",function(){
			var cid = $(this).parents('td').attr("cid");
			
			$("#confirm").dialog({
				height: 150,
				width: 300,
				buttons: {
					'确定' : function(){
						$.post(
							'{:U("Auth/deleteCode")}',
							{
								cid : cid
							},
							function(data){
								alert(data.info);
								if(data.status){
									window.location.reload();
								}
							},
							'json'
						)
					},
					'取消' : function(){
						$(this).dialog("close");
					}
				}
			})
		});
		
	});
	
    function changeCodeFlag(cid, flag, obj){
        $.post('{:U("Auth/changeCodeFlag")}', {
            cid: cid,
            flag: flag
        }, function(data){
            if (data.status) {
                if (flag) {
                    obj.prev().attr('class', 'yesicon');
                    obj.text("启用");
                    obj.attr('class', 'yesbtn');
                }
                else {
                    obj.prev().attr('class', 'stopicon');
                    obj.text("停用");
                    obj.attr('class', 'stopbtn');
                }
            }
            else {
                alert(data.info);
            }
        }, 'json');
    }
	</script>
</html>