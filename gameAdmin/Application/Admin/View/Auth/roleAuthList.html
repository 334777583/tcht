<!DOCTYPE html>
<html>
    <head>
        <title>后台用户权限管理--权限配置</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
<body>
	<div class="container">
		<div>
			<div  id="user-tabs">
				<span id="1" class="user-gray" onclick="window.location.href='{:U(\"Auth/userList\")}'">基本信息</span>
				<span id="2">角色设置</span>
				<span id="3" class="user-gray" onclick="window.location.href='{:U(\"Auth/ruleList\")}'">模块设置</span>
			</div>
			<hr/>
		</div>
		
		<div id="tabs-1" class="tabitem">
			<div style="text-align:right">
				<img src="__IMG__/add-btn2.png" style="cursor: pointer;" id="addbtn"/>
			</div>
		</div>
		
		
		<div id="tabs-2" class="tabitem">
			<div>
				<table 	width="100%" border="0" cellspacing="0" cellpadding="0">
					<tbody>
						<volist name="groups" id="group">
						<tr>
							<td>
								<table 	width="100%" border="0" cellspacing="0" cellpadding="0" class="roletable">
									<tr>
										<td id="{$group['g_id']}">
											<span style="font-size: 25px;">{$group['g_name']}</span>
											<if condition="$group['g_flag'] eq 0">
											<label class="stopicon" style="top:0px"></label>
											<span class="rolestop">停用</span>
											<elseif condition="$group['g_flag'] eq 1"/>
											<label class="yesicon" style="top:0px"></label>
											<span class="roleyes">启用</span>
											</if>
											<label class="deleteicon" style="top:0px"></label>
											<span class="roledelete">删除</span>
											<label class="saveicon" style="top:0px"></label>
											<span class="rolesave">保存</span>
										</td>
									</tr>
									<tr>
										<td class="auth">
											<span>所在用户:</span>
										</td>
									</tr>
									<tr>
										<td>
											<div>
												<volist name="group['userList']" id="ul">
													<div class="usertab" id="{$ul['u_id']}" rel="{$ul['g_id']}">
														<span class="caption">{$ul['u_name']}</span>
														<img id="login" class="closeicon" src="__IMG__/close.gif"/>
													</div>
												</volist>
											</div>
										</td>
									</tr>
									<tr>
										<td class="auth">
											<span>所属权限:</span>
										</td>
									</tr>
									<volist name="ruleList" id="rl">
										<tr bgcolor="#e0f0f0">
											<td>
												<div class="mainmod">
													<span>{$rl['cf_name']}</span>
													<input type="checkbox" class="tmodel" value="{$rl['cf_code']}" />
												</div>
											</td>
										</tr>
										<tr bgcolor="#edf2f7" class="u_{$group['g_id']}">
											<td class="roleSelect">
												<volist name="rl['child']" id="r">
													<if condition="in_array($r['cf_code'],$group['ruleList'])">
													<div  class="modelselect">
														<input type="checkbox" checked="checked" name="list" value="{$r['cf_code']}">
														<span>{$r['cf_name']}</span>
													</div>
													<else/>
													<div  class="modelselect">
														<input type="checkbox" name="list" value="{$r['cf_code']}">
														<span>{$r['cf_name']}</span>
													</div>
													</if>
												</volist>
											</td>
										</tr>
									</volist>
								</td>
							</tr>
							</table>
							</td>
							</tr>
						</volist>
					</tbody>
				</table>
			</div>
			<div style="height:30px">&nbsp;<input type="hidden" id="closeId" value=""/></div>
		</div>
		
	</div>
	<div id="confirm"  style="display:none">
		<div style="text-align: center;">确定要永久删除吗？</div>
	</div>
	
	<div id="editform"  style="display:none">
		<div class="ajaxform">
			<table width="80%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tbody>
					<tr>
						<td align="right">用户组名称：</td>
						<td><input type="text" class="input-1" id="group" ></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	
	<div id="userform"  style="display:none">
		<div class="ajaxform">
			<table width="80%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tbody>
					<tr>
						<td align="right">全选：</td>
						<td><input type="checkbox" id="allUser"></td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
</body>

    <script src="__STATIC__/jquery.js" type="text/javascript">
    </script>
    <script src="__JS__/jquery-ui.js" type="text/javascript">
    </script>
    <script src="__JS__/function.js" type="text/javascript">
    </script>
	
	<script type="text/javascript">
		showTitle("GM工具：权限管理");
	
		//角色设置中，子模块全选对应的大模块选中
		var len = $('body').find(".roleSelect").length;
		if(len > 0){
			$('body').find(".roleSelect").each(function(index,dom){
				var num = $(dom).find(".modelselect").length;	//当前子模块数量
				var snum = $(dom).find("input[name='list']:checked").length;	//选中子模块数量
				if(num ==  snum){
					//alert($(dom).parent().prev().find(".tmodel").html());
					$(dom).parent().prev().find(".tmodel").attr("checked",true);
				}
			})
		}
	</script>
	
	
	<script>
	$(function() {		
		var select = function(){
				var len = $('body').find(".roleSelect").length;
				if(len > 0){
					$('body').find(".roleSelect").each(function(index,dom){
						var num = $(dom).find(".modelselect").length;	//当前子模块数量
						var snum = $(dom).find("input[name='list']:checked").length;	//选中子模块数量
						if(num ==  snum){
							//alert($(dom).parent().prev().find(".tmodel").html());
							$(dom).parent().prev().find(".tmodel").attr("checked",true);
						}
					})
				}
		}
		
		select();
		
		//draggable
		$( ".usertab" ).draggable({
			revert: true,
			addClasses : false,
			opacity: 0.35
		});
		
		//模块选中，底下子模块全部选择
		$(".tmodel").click(function(){
			var $box = $(this).parent().parent().parent().next();
			if($(this).is(":checked")){
				$box.find("input[name=list]").attr("checked",true);
			}else{
				$box.find("input[name=list]").attr("checked",false);
			}
		});
		
		//停用角色
		$(".rolestop").click(function(){
			var id = $(this).parent().attr("id");
			$.post(
				'{:U("Auth/changeGroupFlag")}',
				{
					id : id,
					flag : 1
				},
				function(data){
					if(data.status){
						window.location.reload();
					}else{
						alert(data.info);
					}
				},
				'json'
			);
		})
		
		
		//启用角色
		$(".roleyes").click(function(){
			var id = $(this).parent().attr("id");
			$.post(
				'{:U("Auth/changeGroupFlag")}',
				{
					id : id,
					flag : 0
				},
				function(data){
					if(data.status){
						window.location.reload();
					}else{
						alert(data.info);
					}
				},
				'json'
			);
		})
		
		//保存角色
		$(".rolesave").click(function(){
			var id = $(this).parent().attr("id");
			var codeList =  new Array();
			var codeString = "";
			var userString = "";
			var model = ".u_"+id;
			$(model).find("input[name=list]:checked").each(function(index,dom){
				codeList.push($(dom).val());
			})
			
			$(model).each(function(index,dom){
				if($(dom).find("input[name=list]:checked").length > 0){
					codeList.push($(dom).prev().find(".tmodel").val());
				}
			})
			
			var userList = new Array();
			$(this).parent().parent().next().next().find(".usertab:hidden").each(function(index,dom){
				userList.push($(dom).attr("id"));
			})
			codeString = codeList.join(",");
			userString = userList.join(",");
			$.post(
					'{:U("Auth/saveRule")}',
					{
						id : id,
						codeString : codeString,
						userString : userString
					},
					function(data){
						alert(data.info);
						if(data.status){
							window.location.reload();
						}
					},
					'json'
			);
		})
		
		//关闭用户标签
		$(".closeicon").click(function(){
			var id = $(this).parent().attr("id");
			$(this).parent().hide();
		});
		
		//添加用户组 
		$("#addbtn").click(function(){
			$("#editform").dialog({
				height: 200,
				width: 400,
				buttons: {
					'添加' : function(){
						$.post(
							'{:U("Auth/addGroup")}',
							{
								group : $("#group").val()
							},
							function(data){
								alert(data.info);
								if(data.status){
									window.location.reload();
								}
							},
							'json'
						)
					},
					'取消' : function(){
						$(this).dialog("close");
					}
				}
			})
		})
		
		
		//删除用户组
		$(".roledelete").click(function(){
			if(confirm("是否删除该用户和所属的用户？")) {
				var gid = $(this).parent().attr("id");
				$.post(
					'{:U("Auth/deleteGroup")}',
					{
						id : gid
					},
					function(data){
						alert(data.info);
						if(data.status){
							window.location.reload();
						}
					},
					'json'
				)
				
			}
		})
		
	});

	</script>
	
</html>