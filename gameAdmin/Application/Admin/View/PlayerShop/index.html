<!DOCTYPE html>
<html>
    <head>
        <title>玩家商城消费记录</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <link href="__CSS__/skin.css" rel="stylesheet" type="text/css">
        <link href="__CSS__/jquery-ui.css" rel="stylesheet" type="text/css">
        <style type="text/css">
        <!--body {
            margin-left: 0px;
            margin-top: 0px;
            margin-right: 0px;
            margin-bottom: 0px;
            background-color: #EEF2FB;
            font-size: 12px;
        }
        -->
        </style>
    </head>
    <body>
	<div>
		<div>
			<div>
				<table class="explain">
					<thead>
					</thead>
					<tbody style="font-family:Mingliu">
						<tr>
							<td width="5%"  class="tableleft"><b>说明：</b></td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">1、查询玩家在时间区间内的消费记录</td>
						</tr>
						<tr>
							<td width="95%" class="tableleft">2、角色名支持模糊查询</td>
						</tr>
					</tbody>
				</table>
			</div>
			
			<div class="topinfo">
				<div>
					<span>服务器:</span>
					<select id="serverId">
						<volist name="serverList" id="sl">
						<option value="{$sl['g_id']}">{$sl['g_name']}</option>
						</volist>
						<option value="0">全部</option>
					</select>
					<span>货币类型:</span>
					<select id="money_type">
						<option value="3">元宝</option>
						<option value="4">绑定元宝</option>
						<option value="5">礼券</option>
					</select>
					<span>购买时间:</span>
					<input type="text" class="input1" id="startdate" value="{$today}"/>
					至<input type="text" class="input1" id="enddate" value="{$today}"/>
					<select id="type">
						<option value="2">角色名</option>
						<option value="1">角色ID</option>
					</select>
					<input type="text" class="input1" id="codeValue"/>
					<input type="checkbox" name="isFuzzy" id="isFuzzy"/>
					<label for="isFuzzy">模糊</label>
					<input type="button" value="历史" onclick="getData(1)"/>
					<input type="button" value="当天" onclick="getData(2)"/>
				</div>
			</div>
			
			<div style="clear:both"></div>
			
			<div id="tabs-1" class="tabitem">
				<div>
					<table  class="mytable">
						<thead>
							<tr>
								<th>账号</th>
								<th>角色ID</th>
								<th>角色名</th>
								<th>活动类型</th>
								<th>物品ID</th>
								<th>物品名称</th>
								<th>单价</th>
								<th>数量</th>
								<th>购买时间</th>
							</tr>
						</thead>
						<tbody id=dtatr_body>
						</tbody>
					</table>
				</div>
				<div id="pagediv" style="display:none;">
					<div id="pagehtml" style="float:right;margin-right:20px"></div>
					<div id="example_length" class="dataTables_length">
						<label>每页显示
							<select id="menu" name="example_length" size="1" aria-controls="example">
							<option value="10">10</option>
							<option value="25" selected="selected">25</option>
							<option value="50">50</option>
							<option value="100">100</option>
							</select> 条记录
						</label>
					</div>
				</div>
			</div>
			
			<div style="clear:both"></div>
		</div>
		
		<div style="height:50px">&nbsp;</div>
		
	</div>
	
	<!-- 角色ID与角色名称 -->
	<div id="rform"  style="display:none">
		<div class="ajaxform">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tbody>
					<tr>
						<td>
							<table class="tooltable">
								<thead>
									<tr>
										<th>角色ID</th>
										<th>角色名称</th>
										<th>操作</th>
									</tr>
								</thead>
								<tbody id="rform_body">
								</tbody>
							</table>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>
	
		<!-- 服务器 -->
        <div id="sform" style="display:none">
            <div class="ajaxform">
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout:fixed;">
				<tr>
					<td>
					<volist name="serverList" id="sld" key="k">
                        <if condition="$k%5 eq 0">
                            <br/>
                            <br/>
                        </if>
                        <input type="radio" name="db" value="{$sld['g_id']}" class="cbox" id="s{$k}"/>
                        <label for="s{$k}">
                            {$sld['g_name']}
                        </label>
                        <span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
                    </volist>
					</td>
				</tr>
                </table>
            </div>
        </div>
    
	
    <script src="__STATIC__/jquery.js" type="text/javascript">
    </script>
    <script src="__JS__/jquery-ui.js" type="text/javascript">
    </script>
    <script src="__JS__/function.js" type="text/javascript">
    </script>
	<script type="text/javascript">
	$(document).ready(function(){
		//时间插件
		$("#startdate").datepicker();
		$("#enddate").datepicker();
		
		showTitle("货币相关查询:玩家商城消费");
		
        $("#serverId").change(function(){
            if ($("#serverId").val() == 0) {
                $("#sform").dialog({
                    height: 500,
                    width: 700,
                    buttons: {
                        "确认": function(){
                            var item = $(':radio[name="db"]:checked').val();
                            $("#serverId").val(item);
                            $(this).dialog("close");
                        },
                        "关闭": function(){
                            $(this).dialog("close");
                        }
                    }
                })
            }
        });
        
	});
	
	//queryType1为历史查询，2为当天查询
	function getData(queryType){
		var type = $('#type').val();
		var roleName = $('#codeValue').val();
		if(roleName==''){
			alert('请输入角色名');return false;
		}
		if(type==2&&$('#isFuzzy').is(":checked")){
			getUserPlayId(roleName,queryType);
			return false;
		}
		if(queryType==1){
			getHistoryData(1);
		}else if(queryType==2){
			getCurData();
		}
	}
	
	function getHistoryData(curPage){
		$.ajax({
			type : 'POST',
			url : '{:U("PlayerShop/getHistoryData")}',
			dataType : 'json',
			data : {
				serverId : $("#serverId").val(),
				startdate : $('#startdate').val(),
				enddate : $('#enddate').val(),
				moneyType : $('#money_type').val(),
				type:$('#type').val(),
				codeValue:$('#codeValue').val(),
				curPage:curPage,
				pageSize:$('#menu').val()
			},
			beforeSend : function() {
				$('#pagediv').hide();
				$("#dtatr_body").html("<tr><td colspan='9'><img src='__IMG__/loading.gif'/></td></tr>");
			},
			success : function (data) {
				var list = data.list;
				if(list!=null&&list!='') {
					var tbody = "";
					for(var i in list) {
						tbody += "<tr>";
						tbody += "<td>" +data.playerInfo['account'] + "</td>";
						tbody += "<td>" + list[i]["i_playid"] + "</td>";
						tbody += "<td>" + data.playerInfo['RoleName'] + "</td>";
						//类型 1：普通购买，2：活动购买
						if(list[i]["i_dtype"]==1){
							tbody += "<td>普通购买</td>";
						}else if(list[i]["i_dtype"]==2){
							tbody += "<td>活动购买</td>";
						}else {
							tbody += "<td>未知</td>";
						}
						tbody += "<td>" + list[i]["i_shopid"] + "</td>";
						tbody += "<td>" + list[i]["t_name"] + "</td>";
						tbody += "<td>" + list[i]["i_price"] + "</td>";
						tbody += "<td>" + list[i]["i_num"] + "</td>";
						tbody += "<td>" + list[i]["i_date"] + "</td>";
						tbody += "</tr>";
					}
					$("#dtatr_body").html(tbody);
					$("#dtatr_body tr:odd").css( "background-color", "#e0f0f0");
					$('#pagediv').show();
					$('#pagehtml').html(data.pageHtml);
				}else {
					$("#dtatr_body").html("<tr><td colspan='9'>没有数据！</td></tr>");
				}
			},
			error : function () {
				$("#dtatr_body").html("<tr><td colspan='9'>请求失败！</td></tr>");
			}
		});
	}
	
	function go(){
		var pagenum = $("#page").val();
		if(pagenum=='' || isNaN(pagenum) || pagenum <= 0){
			alert('请输入一个正整数！');
			$("#page").val(1);
		}else{
			getHistoryData(pagenum);
		}
	}
	
	function getCurData(curPage){
		$.ajax({
			type : 'POST',
			url : '{:U("PlayerShop/getCurData")}',
			dataType : 'json',
			data : {
				serverId : $("#serverId").val(),
				moneyType : $('#money_type').val(),
				type:$('#type').val(),
				codeValue:$('#codeValue').val()
			},
			beforeSend : function() {
				$('#pagediv').hide();
				$("#dtatr_body").html("<tr><td colspan='9'><img src='__IMG__/loading.gif'/></td></tr>");
			},
			success : function (data) {
				var list = data.list;
				if(list!=null&&list!='') {
					var tbody = "";
					for(var i in list) {
						tbody += "<tr>";
						tbody += "<td>" +data.playerInfo['account'] + "</td>";
						tbody += "<td>" + list[i]["i_playid"] + "</td>";
						tbody += "<td>" + data.playerInfo['RoleName'] + "</td>";
						//类型 1：普通购买，2：活动购买
						if(list[i]["i_dtype"]==1){
							tbody += "<td>普通购买</td>";
						}else if(list[i]["i_dtype"]==2){
							tbody += "<td>活动购买</td>";
						}else {
							tbody += "<td>未知</td>";
						}
						tbody += "<td>" + list[i]["i_shopid"] + "</td>";
						tbody += "<td>" + list[i]["t_name"] + "</td>";
						tbody += "<td>" + list[i]["i_price"] + "</td>";
						tbody += "<td>" + list[i]["i_num"] + "</td>";
						tbody += "<td>" + list[i]["i_date"] + "</td>";
						tbody += "</tr>";
					}
					$("#dtatr_body").html(tbody);
					$("#dtatr_body tr:odd").css( "background-color", "#e0f0f0");
				}else {
					$("#dtatr_body").html("<tr><td colspan='9'>没有数据！</td></tr>");
				}
			},
			error : function () {
				$("#dtatr_body").html("<tr><td colspan='9'>请求失败！</td></tr>");
			}
		});
	}
	
	function getUserPlayId(roleName,queryType){
		$("#rform").dialog({
			height: 500,
			width: 700,
			buttons :{
				"关闭" : function(){
					$(this).dialog("close");
				}
			}
		});
		$.ajax({
			type : 'POST',
			url : '{:U("PlayerShop/getUserPlayId")}',
			dataType : 'json',
			data : {
				serverId : $("#serverId").val(),
				roleName:roleName
			},
			beforeSend : function(){
				$("#rform_body").html("<tr><td colspan='3'><img src='__IMG__/loading.gif'/></td></tr>");
			},
			success : function(data){
				var list = data.list;
				if(list!=null&&list!=''){
					var html = "";
					for(var i in list){
						html += "<tr>";
						html += "<td class='GUID'>"+list[i]["GUID"]+"</td>";
						html += "<td class='RoleName'>"+list[i]["RoleName"]+"</td>";
						html += "<td><span class='choose'>选择</span></td>";
						html += "</tr>";
					}
					$("#rform_body").html(html);
					
					//选择角色
					$('.choose').click(function(){
						var roleId = $(this).parents('tr').children('.GUID').html();
						var RoleName = $(this).parents('tr').children('.RoleName').html();
						$('#codeValue').val(RoleName);
						$("#rform").dialog("close");
						if(queryType==1){
							getHistoryData(1);
						}else if(queryType==2){
							getCurData();
						}
					});
					
				}else{
					$("#rform_body").html("<tr><td colspan='3'>没有记录！</td></tr>");
				}
			},
			error : function(){
				$("#rform_body").html("<tr><td colspan='3'>请求失败！</td></tr>");
			}
		});
	}
	</script>
</body>
</html>